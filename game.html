<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>M√™ cung tr·∫Øc nghi·ªám</title>
<style>
  canvas { border:1px solid #333; display:block; margin:10px auto; }
  #quiz { display:none; background:#fff; padding:10px; border:1px solid #333; max-width:400px; margin:10px auto; }
  #timer { text-align:center; font-size:18px; margin:10px; }
</style>
</head>
<body>
<h2 style="text-align:center">üéÆ Tr√≤ ch∆°i M√™ cung Tr·∫Øc nghi·ªám</h2>
<div id="timer">‚è± Th·ªùi gian: 0 gi√¢y</div>
<canvas id="maze" width="672" height="672"></canvas>
<div id="quiz"></div>

<script>
const W = 21, H = 21, CELL = 32;
const canvas = document.getElementById('maze');
const ctx = canvas.getContext('2d');
let grid = Array.from({length:H}, ()=>Array(W).fill(1));
let player = {x:1, y:1};
let goal = {x:W-2, y:H-2};
let openedDirections = new Set();
let startTime = Date.now();
let timerInterval;

// ====== Load c√¢u h·ªèi t·ª´ localStorage ======
let questions = JSON.parse(localStorage.getItem("quizData") || "[]");

// ====== Sinh m√™ cung ======
function carveDFS(x,y){
  grid[y][x]=0;
  const dirs=[[2,0],[0,2],[-2,0],[0,-2]].sort(()=>Math.random()-0.5);
  for(const [dx,dy] of dirs){
    const nx=x+dx, ny=y+dy;
    if(nx>0&&ny>0&&nx<W-1&&ny<H-1&&grid[ny][nx]===1){
      grid[y+dy/2][x+dx/2]=0;
      carveDFS(nx,ny);
    }
  }
}
function isJunction(x,y){
  if(grid[y][x]===1) return false;
  let open=0;
  for(const [dx,dy] of [[1,0],[-1,0],[0,1],[0,-1]]){
    if(grid[y+dy]?.[x+dx]===0) open++;
  }
  return open>=3;
}

// ====== V·∫Ω m√™ cung ======
function draw(){
  ctx.fillStyle='#222'; ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      if(grid[y][x]===0){
        ctx.fillStyle='#eee'; ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
        if(isJunction(x,y)){
          ctx.fillStyle='#ffd54f';
          ctx.fillRect(x*CELL+8,y*CELL+8,CELL-16,CELL-16);
        }
      }
    }
  }
  // V·∫°ch ƒë√≠ch
  ctx.fillStyle='#4caf50';
  ctx.fillRect(goal.x*CELL+4, goal.y*CELL+4, CELL-8, CELL-8);
  // Ng∆∞·ªùi ch∆°i
  ctx.fillStyle='#29b6f6';
  ctx.fillRect(player.x*CELL+6,player.y*CELL+6,CELL-12,CELL-12);
}

// ====== C√¢u h·ªèi ======
function askQuestion(dirKey,cbOpen){
  if(questions.length===0){ alert("Ch∆∞a c√≥ c√¢u h·ªèi!"); cbOpen(); return; }
  const q=questions[Math.floor(Math.random()*questions.length)];
  const quiz=document.getElementById('quiz');
  quiz.style.display='block';
  quiz.innerHTML=`<p><b>${q.prompt}</b></p>`+q.choices.map((c,i)=>`<button data-i="${i}">${c}</button>`).join('');
  quiz.onclick=(e)=>{
    const i=Number(e.target.getAttribute('data-i'));
    if(isNaN(i)) return;
    quiz.style.display='none';
    if(i===q.answerIndex){ openedDirections.add(dirKey); cbOpen(); }
    else{ alert("‚ùå Sai r·ªìi!"); }
  };
}

// ====== Di chuy·ªÉn ======
function tryMove(dx,dy){
  const nx=player.x+dx, ny=player.y+dy;
  if(grid[ny]?.[nx]!==0) return;
  const dirKey=`${player.y},${player.x}->${ny},${nx}`;
  if(isJunction(player.x,player.y)&&!openedDirections.has(dirKey)){
    askQuestion(dirKey,()=>{ player.x=nx; player.y=ny; draw(); checkGoal(); });
  } else { player.x=nx; player.y=ny; draw(); checkGoal(); }
}

// ====== Ki·ªÉm tra th·∫Øng ======
function checkGoal(){
  if(player.x===goal.x && player.y===goal.y){
    clearInterval(timerInterval);
    const elapsed = Math.floor((Date.now()-startTime)/1000);
    setTimeout(()=>alert("üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ tho√°t kh·ªèi m√™ cung sau "+elapsed+" gi√¢y!"),100);
  }
}

// ====== Timer ======
function updateTimer(){
  const elapsed = Math.floor((Date.now()-startTime)/1000);
  document.getElementById('timer').textContent="‚è± Th·ªùi gian: "+elapsed+" gi√¢y";
}

// ====== Controls ======
document.addEventListener('keydown',(e)=>{
  if(e.key==='ArrowUp') tryMove(0,-1);
  if(e.key==='ArrowDown') tryMove(0,1);
  if(e.key==='ArrowLeft') tryMove(-1,0);
  if(e.key==='ArrowRight') tryMove(1,0);
});

// ====== Kh·ªüi t·∫°o ======
carveDFS(1,1); draw();
timerInterval=setInterval(updateTimer,1000);
</script>
</body>
</html>
