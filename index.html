<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Mê cung trắc nghiệm</title>
<style>
  canvas { border:1px solid #333; }
  #quiz { display:none; background:#fff; padding:10px; border:1px solid #333; }
</style>
</head>
<body>
<canvas id="maze" width="672" height="672"></canvas>
<div id="quiz"></div>
<script>
// ====== Load câu hỏi từ localStorage ======
let questions = JSON.parse(localStorage.getItem("quizData") || "[]");

// ====== Maze setup ======
const W = 21, H = 21, CELL = 32;
const canvas = document.getElementById('maze');
const ctx = canvas.getContext('2d');
let grid = Array.from({length:H}, ()=>Array(W).fill(1));
let player = {x:1, y:1};
let openedDirections = new Set();

function carveDFS(x,y){
  grid[y][x]=0;
  const dirs=[[2,0],[0,2],[-2,0],[0,-2]].sort(()=>Math.random()-0.5);
  for(const [dx,dy] of dirs){
    const nx=x+dx, ny=y+dy;
    if(nx>0&&ny>0&&nx<W-1&&ny<H-1&&grid[ny][nx]===1){
      grid[y+dy/2][x+dx/2]=0;
      carveDFS(nx,ny);
    }
  }
}
function isJunction(x,y){
  if(grid[y][x]===1) return false;
  let open=0;
  for(const [dx,dy] of [[1,0],[-1,0],[0,1],[0,-1]]){
    if(grid[y+dy]?.[x+dx]===0) open++;
  }
  return open>=3;
}
function draw(){
  ctx.fillStyle='#222'; ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      if(grid[y][x]===0){
        ctx.fillStyle='#eee'; ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
        if(isJunction(x,y)){
          ctx.fillStyle='#ffd54f';
          ctx.fillRect(x*CELL+8,y*CELL+8,CELL-16,CELL-16);
        }
      }
    }
  }
  ctx.fillStyle='#29b6f6';
  ctx.fillRect(player.x*CELL+6,player.y*CELL+6,CELL-12,CELL-12);
}
function askQuestion(dirKey,cbOpen){
  if(questions.length===0){ alert("Chưa có câu hỏi!"); cbOpen(); return; }
  const q=questions[Math.floor(Math.random()*questions.length)];
  const quiz=document.getElementById('quiz');
  quiz.style.display='block';
  quiz.innerHTML=`<p>${q.prompt}</p>`+q.choices.map((c,i)=>`<button data-i="${i}">${c}</button>`).join('');
  quiz.onclick=(e)=>{
    const i=Number(e.target.getAttribute('data-i'));
    quiz.style.display='none';
    if(i===q.answerIndex){ openedDirections.add(dirKey); cbOpen(); }
    else{ alert("Sai rồi!"); }
  };
}
function tryMove(dx,dy){
  const nx=player.x+dx, ny=player.y+dy;
  if(grid[ny]?.[nx]!==0) return;
  const dirKey=`${player.y},${player.x}->${ny},${nx}`;
  if(isJunction(player.x,player.y)&&!openedDirections.has(dirKey)){
    askQuestion(dirKey,()=>{ player.x=nx; player.y=ny; draw(); });
  } else { player.x=nx; player.y=ny; draw(); }
}
document.addEventListener('keydown',(e)=>{
  if(e.key==='ArrowUp') tryMove(0,-1);
  if(e.key==='ArrowDown') tryMove(0,1);
  if(e.key==='ArrowLeft') tryMove(-1,0);
  if(e.key==='ArrowRight') tryMove(1,0);
});
carveDFS(1,1); draw();
</script>
</body>
</html>
